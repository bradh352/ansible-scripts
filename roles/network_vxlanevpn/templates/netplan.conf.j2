{% if network_vtep_ip is not defined %}
{{ notdefined | mandatory(msg='network_vtep_ip must be defined') }}
{% endif %}
network:
  version: 2
  bridges:
    br:
      dhcp4: no
      dhcp6: no
      accept-ra: no
{% if network_vxlan_interfaces|default([])|count > 0 %}
      interfaces:
{%   for interface in network_vxlan_interfaces %}
        - {{ interface.name }}
{%   endfor %}
{% endif %}
{% if network_vxlan_interfaces|default([])|count > 0 %}
  tunnels:
{%   for interface in network_vxlan_interfaces %}
    {{ interface.name }}:
      mode: vxlan
      local: {{ network_vtep_ip }}
      id: {{ interface.vni }}
      mac-learning: false
      link-local: [ ]
      port: 4789
      mtu: {{ interface.mtu|default(1500) }}
{%     if interface.dhcp|default(false) %}
      dhcp4: true
      accept-ra: true
{%     elif interface.addresses|default([])|count > 0 %}
      dhcp4: false
      dhcp6: false
      accept-ra: false
      addresses:
{%       for address in interfaces.addresses %}
        - {{ address }}
{%       endfor %}
{%     endif %}
{%     if interface.routes|default([])|count > 0 %}
      routes:
{%       for route in interface.routes %}
        - to: {{ route.to }}
          via: {{ route.via }}
{%       endfor %}
{%     endif %}
{%     if interface.nameservers is defined %}
      nameservers:
{%       if interface.nameservers.addresses|default([])|count > 0 %}
        addresses:
{%         for address in interface.nameservers.addresses %}
          - {{ address }}
{%         endfor %}
{%     endif %}
{%     if interface.nameservers.search|default([])|count > 0 %}
        search:
{%       for search in interface.nameservers.search %}
          - {{ search }}
{%       endfor %}
{%     endif %}
{%   endfor %}
{% endif %}
  ethernets:
    lo:
      match:
        name: lo
      addresses:
        - 127.0.0.1/32
        - ::1/128
        - {{ network_vtep_ip|split('/')|first }}/32
{% for interface in network_vxlanevpn_interfaces %}
    {{ interface }}:
      link-local: [ ipv6 ]
      mtu: {{ network_underlay_mtu|default(9100) }}
      dhcp4: false
      dhcp6: false
      accept-ra: false
{% endfor %}
{% for interface in network_interfaces %}
    {{ interface.ifname }}:
      link-local: [ ipv6 ]
      mtu: {{ interface.mtu|default(1500) }}
{%   if interface.dhcp|default(false) %}
      dhcp4: true
      accept-ra: true
      dhcp4-overrides:
        use_dns: false
        use-ntp: false
        use-routes: false
        use-domains: false
      ra-overrides:
        use-dns: false
        use-domains: false
{%   elif interface.addresses|default([])|count > 0 %}
      dhcp4: false
      dhcp6: false
      accept-ra: false
      addresses:
{%     for address in interfaces.addresses %}
        - {{ address }}
{%     endfor %}
{%   endif %}
{%   if interface.routes|default([])|count > 0 %}
      routes:
{%     for route in interface.routes %}
        - to: {{ route.to }}
          via: {{ route.via }}
{%     endfor %}
{%   endif %}
{%   if interface.nameservers is defined %}
      nameservers:
{%     if interface.nameservers.addresses|default([])|count > 0 %}
        addresses:
{%       for address in interface.nameservers.addresses %}
          - {{ address }}
{%       endfor %}
{%   endif %}
{%   if interface.nameservers.search|default([])|count > 0 %}
        search:
{%     for search in interface.nameservers.search %}
          - {{ search }}
{%     endfor %}
{%   endif %}
{% endfor %}
